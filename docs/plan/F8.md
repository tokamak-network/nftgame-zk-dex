F8: Card Draw Verify 개발 계획 (Full Fisher-Yates Shuffle)                                                               
                                                                                                                        
 Context

 F1, F4, F5가 완료된 상태에서 최종 기능 F8 (Card Draw Verify)을 개발합니다.
 원본 명세의 Fisher-Yates 셔플 기반 풀 덱 검증 방식으로 구현합니다.

 기존 기능과의 비교
 ┌───────────┬─────────────┬─────────────┬─────────────┬─────────────────────────────┐
 │           │     F1      │     F4      │     F5      │             F8              │
 ├───────────┼─────────────┼─────────────┼─────────────┼─────────────────────────────┤
 │ 제약조건  │ ~6.4K       │ ~7.3K       │ ~7.7K       │ ~75-100K                    │
 ├───────────┼─────────────┼─────────────┼─────────────┼─────────────────────────────┤
 │ 노트 패턴 │ 1소비→1생성 │ 1소비→1생성 │ 1소비→1생성 │ 덱 persistent + 드로우 생성 │
 ├───────────┼─────────────┼─────────────┼─────────────┼─────────────────────────────┤
 │ 랜덤성    │ 없음        │ PoseidonVRF │ 없음        │ Fisher-Yates 셔플           │
 ├───────────┼─────────────┼─────────────┼─────────────┼─────────────────────────────┤
 │ Nullifier │ 있음        │ 있음        │ 있음        │ drawIndex로 대체            │
 └───────────┴─────────────┴─────────────┴─────────────┴─────────────────────────────┘
 F8의 핵심 특징

 1. 풀 셔플 검증 — Fisher-Yates로 52장 전체 덱 순서를 회로 내에서 재현/검증
 2. 덱 커밋먼트 — 셔플된 52장 전체를 재귀 Poseidon 체인으로 커밋
 3. 숨겨진 카드 — drawnCard, deckCards[52] 모두 private
 4. 다중 드로우 — 같은 덱에서 여러 번 드로우 (drawIndex로 관리)
 5. drawIndex 기반 중복 방지 — nullifier 대신 on-chain drawIndex 추적

 회로 설계

 구조 개요

 CardDraw(N=52)
 ├── ProofOfOwnership() ................. 소유권 증명 (~4,800)
 ├── Poseidon(3) ........................ playerCommitment 계산 (~300)
 ├── FisherYatesShuffle(N=52) ........... 덱 셔플 검증 (~50,000)
 │   ├── 51× Poseidon(2) ............... 랜덤값 생성 (~15,300)
 │   ├── 51× Num2Bits(254)+Bits2Num(14). 비트 추출 (~13,700)
 │   ├── 51× 나눗셈 증명 ............... 모듈러 연산 (~2,200)
 │   └── 51× ArrayRead(52)+조건부 쓰기 .. 스왑 실행 (~21,000)
 ├── DeckCommitment(N=52) ............... 덱 해시 체인 (~15,600)
 ├── ArrayRead(52) ...................... 드로우 카드 읽기 (~210)
 ├── Poseidon(4) ........................ drawCommitment 계산 (~300)
 └── LessThan 바운드 체크 ............... drawIndex, drawnCard (~60)
 예상 총: ~75,000-100,000 제약조건

 Public Inputs (5)
 ┌─────┬──────────────────┬─────────────────────────────────────────────────┐
 │  #  │      Signal      │                      설명                       │
 ├─────┼──────────────────┼─────────────────────────────────────────────────┤
 │ 0   │ deckCommitment   │ 셔플된 전체 덱의 해시 커밋먼트                  │
 ├─────┼──────────────────┼─────────────────────────────────────────────────┤
 │ 1   │ drawCommitment   │ 드로우한 카드의 커밋먼트                        │
 ├─────┼──────────────────┼─────────────────────────────────────────────────┤
 │ 2   │ drawIndex        │ 덱에서 드로우할 위치 (0-51)                     │
 ├─────┼──────────────────┼─────────────────────────────────────────────────┤
 │ 3   │ gameId           │ 게임 세션 식별자                                │
 ├─────┼──────────────────┼─────────────────────────────────────────────────┤
 │ 4   │ playerCommitment │ 플레이어 ID 커밋먼트 Poseidon(pkX, pkY, gameId) │
 └─────┴──────────────────┴─────────────────────────────────────────────────┘
 Private Inputs (8 + N)
 ┌──────────────────────┬────────────────────────────────────────┐
 │        Signal        │                  설명                  │
 ├──────────────────────┼────────────────────────────────────────┤
 │ playerPkX, playerPkY │ BabyJubJub 공개키                      │
 ├──────────────────────┼────────────────────────────────────────┤
 │ playerSk             │ 비밀키                                 │
 ├──────────────────────┼────────────────────────────────────────┤
 │ shuffleSeed          │ 셔플 시드 (랜덤성의 원천)              │
 ├──────────────────────┼────────────────────────────────────────┤
 │ deckCards[52]        │ 셔플된 전체 덱 순서                    │
 ├──────────────────────┼────────────────────────────────────────┤
 │ drawnCard            │ 드로우된 카드 (= deckCards[drawIndex]) │
 ├──────────────────────┼────────────────────────────────────────┤
 │ handSalt             │ 드로우 커밋먼트용 솔트                 │
 ├──────────────────────┼────────────────────────────────────────┤
 │ deckSalt             │ 덱 커밋먼트용 솔트                     │
 └──────────────────────┴────────────────────────────────────────┘
 회로 흐름

 1. 소유권 증명: ProofOfOwnership(pk=[pkX, pkY], sk)
 2. 플레이어 커밋먼트: Poseidon(pkX, pkY, gameId) === playerCommitment
 3. 셔플 검증: FisherYatesShuffle(shuffleSeed) → 결과가 deckCards[52]와 일치하는지 확인
 4. 덱 커밋먼트: DeckCommitment(deckCards[52], deckSalt) === deckCommitment
 5. 카드 드로우: deckCards[drawIndex] === drawnCard (ArrayRead 멀티플렉서)
 6. 드로우 커밋먼트: Poseidon(drawnCard, drawIndex, gameId, handSalt) === drawCommitment
 7. 바운드 체크: drawIndex < 52, drawnCard < 52

 Fisher-Yates 셔플 알고리즘 (회로 내)

 초기 덱: [0, 1, 2, ..., 51]
 for s = 0 to 50:
     i = 51 - s                          // 스왑 위치 (컴파일 타임)
     r = Poseidon(shuffleSeed, s)        // 랜덤값 생성
     j = extract14bits(r) % (i + 1)      // 스왑 대상 인덱스
     swap(deck[i], deck[j])              // 가변 인덱스 스왑
 결과: deck === deckCards (검증)

 유틸리티 회로

 1. FisherYatesShuffle(N) — circuits/utils/shuffle/fisher_yates.circom
   - 입력: seed, verifyCard[N]
   - 내부: N-1 단계의 셔플 시뮬레이션 + 최종 검증
   - 가변 인덱스 접근: IsEqual 멀티플렉서 사용
 2. ArrayRead(N) — circuits/utils/array/array_read.circom
   - 입력: arr[N], index
   - 출력: arr[index] 값
   - N개 IsEqual 비교로 가변 인덱스 읽기
 3. DeckCommitment(N) — circuits/utils/poseidon/deck_commitment.circom
   - 재귀 Poseidon 체인: h[0]=cards[0], h[i]=Poseidon(h[i-1], cards[i])
   - 최종: Poseidon(h[N-1], salt)

 구현 파일 목록

 1. 유틸리티 회로 (3개)

 - circuits/utils/array/array_read.circom — ArrayRead(N) 템플릿
 - circuits/utils/shuffle/fisher_yates.circom — FisherYatesShuffle(N) 템플릿
 - circuits/utils/poseidon/deck_commitment.circom — DeckCommitment(N) 템플릿

 2. 메인 회로

 - circuits/main/card_draw.circom
   - template CardDraw(N), component main = CardDraw(52)
   - 재사용: ProofOfOwnership, ArrayRead, FisherYatesShuffle, DeckCommitment

 3. 컨트랙트

 - contracts/verifiers/IGroth16Verifier.sol 수정 — ICardDrawVerifier 추가
 - contracts/CardDraw.sol — 메인 컨트랙트
   - NFTNoteBase 상속
   - registerDeck(deckCommitment, gameId, encryptedNote) — 덱 등록
   - drawCard(proof, drawCommitment, drawIndex, gameId, playerCommitment, encryptedCardNote) — 카드 드로우
   - drawnCards[gameId][drawIndex] — 중복 드로우 방지 (nullifier 대신)
   - 덱 커밋먼트는 persistent (소비하지 않음), 드로우 노트만 생성
 - contracts/test/MockCardDrawVerifier.sol — Mock 검증자

 4. 테스트

 - test/circuits/card-draw.test.js (~14 테스트)
   - 유효한 드로우, 다른 인덱스, 다른 시드→다른 셔플
   - 잘못된 sk/shuffleSeed/drawnCard/drawIndex/gameId
   - drawIndex >= 52, drawnCard >= 52
   - public signal 변조
 - test/CardDraw.test.js (~9 테스트)
   - 덱 등록, 중복 거부, Mock 드로우, 중복 drawIndex 거부, 이벤트
 - test/foundry/CardDraw.t.sol (~15 테스트)
   - 등록, 드로우, 다중 드로우 (index 0→1→2), 거부 케이스, fuzz
 - test/CardDraw.integration.test.js (~9 테스트)
   - 실제 ZK 증명 드로우, 다중 드로우, 거부, 이벤트

 실행 순서

 1. 유틸리티 회로 작성 (ArrayRead, FisherYatesShuffle, DeckCommitment)
 2. 메인 회로 작성 (card_draw.circom)
 3. 컨트랙트 작성 (ICardDrawVerifier + MockCardDrawVerifier + CardDraw.sol)
 4. Hardhat + Foundry 컴파일
 5. Mock 컨트랙트 테스트 작성 + 실행
 6. Foundry 테스트 작성 + 실행
 7. 회로 컴파일 (node scripts/compile-circuit.js card_draw) — ~5-10분 소요
 8. 회로 단위 테스트 작성 + 실행
 9. Solidity verifier 생성 + 통합 테스트 작성 + 실행
 10. 문서 업데이트

 성능 예상
 ┌─────────────────────┬──────────────────────────────┐
 │        항목         │              값              │
 ├─────────────────────┼──────────────────────────────┤
 │ 제약조건            │ ~75,000-100,000              │
 ├─────────────────────┼──────────────────────────────┤
 │ 증명 생성 (Node.js) │ ~10-30초                     │
 ├─────────────────────┼──────────────────────────────┤
 │ zkey 파일 크기      │ ~50-100 MB                   │
 ├─────────────────────┼──────────────────────────────┤
 │ Groth16 setup 시간  │ ~5-10분                      │
 ├─────────────────────┼──────────────────────────────┤
 │ ptau 요구           │ power 17+ (우리: power 22 ✓) │
 └─────────────────────┴──────────────────────────────┘
 검증

 npx hardhat test test/CardDraw.test.js
 forge test --match-contract CardDrawTest
 npx mocha test/circuits/card-draw.test.js --timeout 300000  # 셔플 회로는 느림
 npx hardhat test test/CardDraw.integration.test.js